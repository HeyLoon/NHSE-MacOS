name: Build NHSE

on:
  push:
    branches: [ master, main, macos-port ]
  pull_request:
    branches: [ master, main ]

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'
        
    - name: Restore dependencies
      run: dotnet restore NHSE.slnx
      
    - name: Build
      run: dotnet build NHSE.slnx --configuration Release --no-restore
      
    - name: Test
      run: dotnet test NHSE.slnx --no-build --verbosity normal
      
    - name: Publish
      run: dotnet publish NHSE.WinForms/NHSE.WinForms.csproj --configuration Release --output ./publish/windows
      
    - name: Upload Windows Artifact
      uses: actions/upload-artifact@v4
      with:
        name: NHSE-Windows
        path: ./publish/windows

  build-macos:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'
        
    - name: Restore dependencies
      run: dotnet restore NHSE.slnx
      
    - name: Build Core Libraries
      run: dotnet build NHSE.Core/NHSE.Core.csproj --configuration Release --no-restore
      
    - name: Build macOS UI
      run: dotnet build NHSE.macOS/NHSE.macOS.csproj --configuration Release --no-restore
      
    - name: Test
      run: dotnet test NHSE.slnx --no-build --verbosity normal
      
    - name: Publish macOS App
      run: >
        dotnet publish NHSE.macOS/NHSE.macOS.csproj 
        --configuration Release 
        --runtime osx-arm64 
        --self-contained true 
        --output ./publish/macos-arm64
          
    - name: Create macOS App Bundle
      run: |
        cd ./publish/macos-arm64
        chmod +x NHSE.macOS
        mkdir -p "NHSE.app/Contents/MacOS"
        mkdir -p "NHSE.app/Contents/Resources"
        cp -r * "NHSE.app/Contents/MacOS/" 2>/dev/null || true
        cat > "NHSE.app/Contents/Info.plist" << 'PLIST_EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleName</key>
            <string>NHSE</string>
            <key>CFBundleDisplayName</key>
            <string>Animal Crossing Save Editor</string>
            <key>CFBundleIdentifier</key>
            <string>com.nhse.mac</string>
            <key>CFBundleVersion</key>
            <string>1.0</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>CFBundleExecutable</key>
            <string>NHSE.macOS</string>
            <key>LSMinimumSystemVersion</key>
            <string>10.15</string>
        </dict>
        </plist>
        PLIST_EOF
        rm -rf NHSE.macOS NHSE.macOS.dbg 2>/dev/null || true
        
    - name: Upload macOS Artifact
      uses: actions/upload-artifact@v4
      with:
        name: NHSE-macOS
        path: ./publish/macos-arm64/NHSE.app

  build-linux:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'
        
    - name: Restore dependencies
      run: dotnet restore NHSE.slnx
      
    - name: Build Core Libraries
      run: dotnet build NHSE.Core/NHSE.Core.csproj --configuration Release --no-restore
      
    - name: Test
      run: dotnet test NHSE.Tests/NHSE.Tests.csproj --no-build --verbosity normal
